<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SVG Instrument Tester</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: #fff;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        background: rgba(0, 0, 0, 0.3);
        padding: 20px;
        text-align: center;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      }

      .header h1 {
        font-size: 2em;
        margin-bottom: 10px;
      }

      .header p {
        color: #aaa;
        font-size: 0.9em;
      }

      .container {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        gap: 20px;
      }

      .drop-zone {
        border: 3px dashed rgba(255, 255, 255, 0.3);
        border-radius: 15px;
        padding: 40px;
        text-align: center;
        background: rgba(255, 255, 255, 0.05);
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .drop-zone.dragover {
        border-color: #00ff88;
        background: rgba(0, 255, 136, 0.1);
        transform: scale(1.02);
      }

      .drop-zone.has-file {
        display: none;
      }

      .hidden {
        display: none !important;
      }

      .drop-zone-icon {
        font-size: 4em;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .drop-zone h2 {
        margin-bottom: 10px;
      }

      .drop-zone p {
        color: #aaa;
        margin-bottom: 15px;
      }

      .file-input {
        display: none;
      }

      .browse-btn {
        background: #00ff88;
        color: #1a1a2e;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .browse-btn:hover {
        background: #00dd77;
        transform: scale(1.05);
      }

      .viewer-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .controls {
        background: rgba(0, 0, 0, 0.3);
        padding: 20px;
        border-radius: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        justify-content: space-between;
      }

      .control-group {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .control-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        user-select: none;
      }

      .control-label input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .param-input-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .param-input-group label {
        font-size: 0.9em;
        color: #aaa;
      }

      .param-input-group input[type="number"] {
        width: 80px;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.3);
        color: white;
        font-size: 0.9em;
      }

      .clear-btn {
        background: #000;
        color: white;
        border: 1px solid #ff4444;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .clear-btn:hover {
        background: #cc0000;
        transform: scale(1.05);
      }

      .svg-viewer {
        flex: 1;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        position: relative;
      }

      .svg-viewer.hidden {
        display: none;
      }

      .svg-viewer svg {
        width: 100%;
        height: 100%;
        max-width: 800px;
        max-height: 600px;
      }

      .placeholder {
        text-align: center;
        color: #666;
      }

      .placeholder-icon {
        font-size: 5em;
        margin-bottom: 20px;
      }

      .info-panel {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        border-radius: 10px;
        font-size: 0.85em;
        color: #aaa;
      }

      .info-panel h3 {
        color: #00ff88;
        margin-bottom: 10px;
        font-size: 1em;
      }

      .info-panel ul {
        list-style: none;
        padding-left: 0;
      }

      .info-panel li {
        padding: 5px 0;
        padding-left: 20px;
        position: relative;
      }

      .info-panel li:before {
        content: "‚Üí";
        position: absolute;
        left: 0;
        color: #00ff88;
      }

      .file-info {
        background: rgba(0, 255, 136, 0.1);
        padding: 10px 15px;
        border-radius: 8px;
        border-left: 3px solid #00ff88;
      }

      .file-info strong {
        color: #00ff88;
      }

      @media (max-width: 768px) {
        .controls {
          flex-direction: column;
          align-items: stretch;
        }

        .control-group {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Drop Zone -->
      <div class="drop-zone" id="dropZone">
        <div class="drop-zone-icon">üìÅ</div>
        <h1>SVG Instrument Tester</h1>
        <h2>Drop your SVG file here to test the code and animation</h2>
        <p>or</p>
        <button class="browse-btn" onclick="document.getElementById('fileInput').click()">Browse Files</button>
        <input type="file" id="fileInput" class="file-input" accept=".svg,image/svg+xml" />
      </div>

      <!-- Viewer Section (hidden until file is loaded) -->
      <div class="viewer-section" id="viewerSection" style="display: none">
        <!-- SVG Viewer -->
        <div class="svg-viewer" id="svgViewer">
          <object id="svgObject" type="image/svg+xml"></object>
        </div>

        <!-- Controls -->
        <div class="controls">
          <div class="control-group">
            <label class="control-label hidden">
              <input type="checkbox" id="testModeCheckbox" checked />
              <span>Test Mode Animation</span>
            </label>

            <div class="param-input-group hidden">
              <label for="cycleSpeed">Cycle Duration (ms):</label>
              <input type="number" id="cycleSpeed" value="5000" min="1000" max="30000" step="500" />
            </div>

            <div class="param-input-group hidden">
              <label for="updateInterval">Update Rate (ms):</label>
              <input type="number" id="updateInterval" value="50" min="10" max="500" step="10" />
            </div>
          </div>

          <button class="clear-btn" id="clearBtn">Clear & Load New File</button>
        </div>

        <!-- File Info -->
        <div class="file-info" id="fileInfo"></div>

        <!-- SVG Viewer -->
        <!-- <div class="svg-viewer" id="svgViewer">
        </div> -->

        <!-- Info Panel -->
        <div class="info-panel">
          <h3>How Test Mode Works:</h3>
          <ul>
            <li>Test mode automatically animates values from 0 to 100 and back in a continuous loop</li>
            <li>Your SVG reads values from localStorage using testMode_&lt;instrumentName&gt; keys</li>
            <li>The SVG should check localStorage with setInterval() just like in the main game</li>
            <li>Open browser DevTools Console to see test values and any errors from your SVG</li>
            <li>Click "Clear & Load New File" to test a different instrument</li>
          </ul>
        </div>
      </div>
    </div>

    <script>
      // ========================================
      // SVG Instrument Tester
      // ========================================

      let testModeInterval = null;
      let currentFileName = "";
      let instrumentName = "";

      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");
      const viewerSection = document.getElementById("viewerSection");
      const svgViewer = document.getElementById("svgViewer");
      const testModeCheckbox = document.getElementById("testModeCheckbox");
      const clearBtn = document.getElementById("clearBtn");
      const fileInfo = document.getElementById("fileInfo");
      const cycleSpeedInput = document.getElementById("cycleSpeed");
      const updateIntervalInput = document.getElementById("updateInterval");

      // Prevent default drag behaviors
      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      // Highlight drop zone when dragging over it
      ["dragenter", "dragover"].forEach((eventName) => {
        dropZone.addEventListener(
          eventName,
          () => {
            dropZone.classList.add("dragover");
          },
          false
        );
      });

      ["dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(
          eventName,
          () => {
            dropZone.classList.remove("dragover");
          },
          false
        );
      });

      // Handle dropped files
      dropZone.addEventListener("drop", handleDrop, false);
      fileInput.addEventListener("change", handleFileSelect, false);

      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
      }

      function handleFileSelect(e) {
        const files = e.target.files;
        handleFiles(files);
      }

      function handleFiles(files) {
        if (files.length === 0) return;

        const file = files[0];

        // Check if it's an SVG file
        if (!file.type.includes("svg") && !file.name.endsWith(".svg")) {
          alert("Please select an SVG file");
          return;
        }

        loadSVGFile(file);
      }

      function loadSVGFile(file) {
        currentFileName = file.name;

        // Extract instrument name from filename (e.g., "depth.svg" -> "depth", "instruments-depth-claude.svg" -> "depth")
        const match = file.name.match(/instruments?[-_](\w+)/i);
        instrumentName = match ? match[1] : "instrument";

        // Read the file and inject it inline to share localStorage context
        const reader = new FileReader();
        reader.onload = function (e) {
          // Get the SVG content
          const svgContent = e.target.result;

          // Parse the SVG to extract and execute scripts manually
          // (innerHTML doesn't execute scripts in SVG)
          const parser = new DOMParser();
          const svgDoc = parser.parseFromString(svgContent, "image/svg+xml");
          const svgElement = svgDoc.documentElement;

          // Extract script content
          const scripts = svgElement.querySelectorAll("script");
          const scriptContents = Array.from(scripts).map((s) => s.textContent);

          // Remove scripts from SVG (we'll execute them separately)
          scripts.forEach((s) => s.remove());

          // Inject the SVG (without scripts)
          svgViewer.innerHTML = "";
          svgViewer.appendChild(document.importNode(svgElement, true));

          // Now execute the scripts in the main document context
          scriptContents.forEach((scriptContent) => {
            try {
              eval(scriptContent);
            } catch (err) {
              console.error("Error executing SVG script:", err);
            }
          });

          // Update UI
          dropZone.classList.add("has-file");
          viewerSection.style.display = "flex";
          fileInfo.innerHTML = `<strong>Loaded:</strong> ${currentFileName} <strong>|</strong> <strong>Instrument:</strong> ${instrumentName}`;

          // Give the SVG scripts a moment to execute
          setTimeout(() => {
            // Auto-start test mode
            testModeCheckbox.checked = true;
            startTestMode();

            console.log(`Loaded ${currentFileName} as instrument: ${instrumentName}`);
            // console.log("SVG scripts should now be running...");

            // Debug: Check if SVG can find its elements
            const svgElement = svgViewer.querySelector("svg");
            const indicator = document.getElementById("indicator");
            // console.log("SVG element found:", !!svgElement);
            // console.log("Indicator element found:", !!indicator);
            if (indicator) {
              // console.log("Indicator initial position:", indicator.getAttribute("x1"));

              // Watch for changes to see if SVG is updating
              let lastX = indicator.getAttribute("x1");
              setInterval(() => {
                const currentX = indicator.getAttribute("x1");
                if (currentX !== lastX) {
                  // console.log(`‚úì Indicator moved! x1 changed from ${lastX} to ${currentX}`);
                  lastX = currentX;
                }
              }, 500);
            }
          }, 100);
        };
        reader.readAsText(file);
      }

      // Test Mode functionality
      testModeCheckbox.addEventListener("change", function () {
        if (this.checked) {
          startTestMode();
        } else {
          stopTestMode();
        }
      });

      // Update test mode parameters on the fly
      cycleSpeedInput.addEventListener("change", () => {
        if (testModeCheckbox.checked) {
          stopTestMode();
          startTestMode();
        }
      });

      updateIntervalInput.addEventListener("change", () => {
        if (testModeCheckbox.checked) {
          stopTestMode();
          startTestMode();
        }
      });

      function startTestMode() {
        const loopDuration = parseInt(cycleSpeedInput.value) || 5000;
        const updateRate = parseInt(updateIntervalInput.value) || 50;
        const startTime = Date.now();

        // console.log(`Starting test mode for ${instrumentName} (cycle: ${loopDuration}ms, update: ${updateRate}ms)`);

        testModeInterval = setInterval(() => {
          const elapsed = Date.now() - startTime;
          const cyclePosition = (elapsed % loopDuration) / loopDuration; // 0 to 1

          // Create triangle wave: 0 -> 100 -> 0
          const percentage =
            cyclePosition < 0.5
              ? cyclePosition * 200 // 0 to 100 in first half
              : (1 - cyclePosition) * 200; // 100 to 0 in second half

          // For compass, use degree value (0-360)
          const value = instrumentName.toLowerCase() === "compass" ? percentage * 3.6 : percentage;

          // Write to localStorage - SVG will read from it
          const testKey = `testMode_${instrumentName}`;
          localStorage.setItem(testKey, value.toString());

          // Debug: Log occasionally
          if (Math.floor(elapsed / 1000) !== Math.floor((elapsed - updateRate) / 1000)) {
            const storedValue = localStorage.getItem(testKey);
            // console.log(`Writing to localStorage: ${testKey} = ${value.toFixed(2)} | Stored value: ${storedValue}`);
          }
        }, updateRate);
      }

      function stopTestMode() {
        if (testModeInterval) {
          clearInterval(testModeInterval);
          testModeInterval = null;

          // Clear the test mode value from localStorage
          const testKey = `testMode_${instrumentName}`;
          localStorage.removeItem(testKey);

          // console.log(`Stopped test mode for ${instrumentName}`);
        }
      }

      // Clear button
      clearBtn.addEventListener("click", () => {
        // Stop test mode if running
        testModeCheckbox.checked = false;
        stopTestMode();

        // Clear the SVG
        svgViewer.innerHTML = "";
        currentFileName = "";
        instrumentName = "";

        // Reset UI
        dropZone.classList.remove("has-file");
        viewerSection.style.display = "none";
        fileInput.value = "";

        // console.log("Cleared SVG and reset tester");
      });

      // Cleanup on page unload
      window.addEventListener("beforeunload", () => {
        stopTestMode();
      });

      console.log("SVG Instrument Tester loaded");
      console.log('Drag and drop an SVG file or click "Browse Files" to begin');
    </script>
  </body>
</html>
